# é‚®ä»¶åè®®äº¤äº’æµç¨‹å›¾

## å®Œæ•´é‚®ä»¶ç³»ç»Ÿäº¤äº’æµç¨‹å›¾ï¼ˆMermaidï¼‰

ä»¥ä¸‹æ˜¯ä¸€ä¸ªè¯¦ç»†çš„é‚®ä»¶åè®®äº¤äº’æµç¨‹å›¾ï¼Œå±•ç¤ºäº†ä»é‚®ä»¶å‘é€åˆ°æ¥æ”¶çš„å®Œæ•´è¿‡ç¨‹ï¼ŒåŒ…æ‹¬SMTPå’ŒPOP3åè®®çš„è¯¦ç»†äº¤äº’ã€‚

```mermaid
sequenceDiagram
    participant Alice as å‘é€æ–¹å®¢æˆ·ç«¯<br/>(Alice)
    participant MSA as é‚®ä»¶æäº¤ä»£ç†<br/>(MSA)
    participant MTA_S as å‘é€æ–¹SMTPæœåŠ¡å™¨<br/>(smtp.sender.com)
    participant DNS as DNSæœåŠ¡å™¨
    participant MTA_R as æ¥æ”¶æ–¹SMTPæœåŠ¡å™¨<br/>(smtp.receiver.com)
    participant POP3 as POP3æœåŠ¡å™¨<br/>(pop3.receiver.com)
    participant Bob as æ¥æ”¶æ–¹å®¢æˆ·ç«¯<br/>(Bob)

    %% æ ·å¼å®šä¹‰
    note over Alice: ğŸ“§ é‚®ä»¶åˆ›å»ºé˜¶æ®µ
    note over Alice: RFC 5322 æ¶ˆæ¯æ ¼å¼

    %% SMTPæäº¤é˜¶æ®µ - å‘é€æ–¹å®¢æˆ·ç«¯åˆ°MSA
    rect rgb(255, 240, 230)
        note over Alice, MSA: ğŸ”´ SMTPé‚®ä»¶æäº¤é˜¶æ®µ (RFC 6409)
        Alice->>MSA: TCPè¿æ¥ (ç«¯å£587)
        MSA-->>Alice: 220 MSAæœåŠ¡å°±ç»ª
        
        Alice->>MSA: EHLO alice-client.local
        MSA-->>Alice: 250-MSA Hello alice-client.local<br/>250-SIZE 52428800<br/>250-AUTH PLAIN LOGIN<br/>250-STARTTLS<br/>250 8BITMIME
        
        Alice->>MSA: STARTTLS
        MSA-->>Alice: 220 å¼€å§‹TLSåŠ å¯†
        note over Alice, MSA: ğŸ”’ TLSæ¡æ‰‹å®Œæˆ
        
        Alice->>MSA: AUTH PLAIN [è®¤è¯ä¿¡æ¯]
        MSA-->>Alice: 235 è®¤è¯æˆåŠŸ
        
        Alice->>MSA: MAIL FROM:<alice@sender.com>
        MSA-->>Alice: 250 å‘é€è€…å·²æ¥å—
        
        Alice->>MSA: RCPT TO:<bob@receiver.com>
        MSA-->>Alice: 250 æ¥æ”¶è€…å·²æ¥å—
        
        Alice->>MSA: DATA
        MSA-->>Alice: 354 å¼€å§‹è¾“å…¥é‚®ä»¶å†…å®¹
        Alice->>MSA: From: alice@sender.com<br/>To: bob@receiver.com<br/>Subject: æµ‹è¯•é‚®ä»¶<br/><br/>è¿™æ˜¯é‚®ä»¶æ­£æ–‡<br/>.
        MSA-->>Alice: 250 é‚®ä»¶å·²æ¥å—å¾…ä¼ è¾“
        
        Alice->>MSA: QUIT
        MSA-->>Alice: 221 è¿æ¥å…³é—­
    end

    %% MTAé—´ä¼ è¾“é˜¶æ®µ
    rect rgb(230, 255, 230)
        note over MSA, MTA_R: ğŸŸ¢ SMTPä¸­ç»§ä¼ è¾“é˜¶æ®µ (RFC 5321)
        
        MSA->>DNS: MXæŸ¥è¯¢ receiver.com
        DNS-->>MSA: MXè®°å½•: smtp.receiver.com
        
        MSA->>MTA_R: TCPè¿æ¥ (ç«¯å£25)
        MTA_R-->>MSA: 220 smtp.receiver.com ESMTPå°±ç»ª
        
        MSA->>MTA_R: EHLO smtp.sender.com
        MTA_R-->>MSA: 250-smtp.receiver.com Hello<br/>250-SIZE 104857600<br/>250-8BITMIME<br/>250-STARTTLS<br/>250 PIPELINING
        
        MSA->>MTA_R: STARTTLS
        MTA_R-->>MSA: 220 å¼€å§‹TLSåŠ å¯†
        note over MSA, MTA_R: ğŸ”’ æœåŠ¡å™¨é—´TLSåŠ å¯†
        
        MSA->>MTA_R: MAIL FROM:<alice@sender.com>
        MTA_R-->>MSA: 250 å‘é€è€…OK
        
        MSA->>MTA_R: RCPT TO:<bob@receiver.com>
        MTA_R-->>MSA: 250 æ¥æ”¶è€…OK (æœ¬åœ°ç”¨æˆ·)
        
        MSA->>MTA_R: DATA
        MTA_R-->>MSA: 354 å‡†å¤‡æ¥æ”¶æ•°æ®
        MSA->>MTA_R: Received: from alice-client.local<br/>From: alice@sender.com<br/>To: bob@receiver.com<br/>Subject: æµ‹è¯•é‚®ä»¶<br/><br/>è¿™æ˜¯é‚®ä»¶æ­£æ–‡<br/>.
        MTA_R-->>MSA: 250 é‚®ä»¶å·²æ¥å—å¾…æŠ•é€’
        
        MSA->>MTA_R: QUIT
        MTA_R-->>MSA: 221 è¿æ¥å…³é—­
    end

    %% é‚®ä»¶å­˜å‚¨é˜¶æ®µ
    note over MTA_R: ğŸ“ é‚®ä»¶å­˜å‚¨ä¸å¤„ç†
    note over MTA_R: æ·»åŠ Receivedå¤´éƒ¨<br/>ç—…æ¯’æ‰«æ/åƒåœ¾é‚®ä»¶è¿‡æ»¤<br/>å­˜å‚¨åˆ°bob@receiver.comé‚®ç®±

    %% POP3æ£€ç´¢é˜¶æ®µ
    rect rgb(230, 230, 255)
        note over Bob, POP3: ğŸ”µ POP3é‚®ä»¶æ£€ç´¢é˜¶æ®µ (RFC 1939)
        
        Bob->>POP3: TCPè¿æ¥ (ç«¯å£995-SSL/TLS)
        POP3-->>Bob: +OK POP3æœåŠ¡å™¨å°±ç»ª <timestamp>
        note over Bob, POP3: ğŸ”’ SSL/TLSè¿æ¥å·²å»ºç«‹
        
        Bob->>POP3: USER bob
        POP3-->>Bob: +OK ç”¨æˆ·åå·²æ¥å—
        
        Bob->>POP3: PASS [å¯†ç ]
        POP3-->>Bob: +OK é‚®ç®±å·²æ‰“å¼€, 3å°é‚®ä»¶
        
        note over Bob, POP3: ğŸ“Š TRANSACTIONçŠ¶æ€å¼€å§‹
        
        Bob->>POP3: STAT
        POP3-->>Bob: +OK 3 4096
        
        Bob->>POP3: LIST
        POP3-->>Bob: +OK 3å°é‚®ä»¶ (4096å­—èŠ‚)<br/>1 1024<br/>2 2048<br/>3 1024<br/>.
        
        Bob->>POP3: UIDL
        POP3-->>Bob: +OK å”¯ä¸€æ ‡è¯†ç¬¦åˆ—è¡¨<br/>1 msg001@receiver.com<br/>2 msg002@receiver.com<br/>3 msg003@receiver.com<br/>.
        
        Bob->>POP3: TOP 3 10
        POP3-->>Bob: +OK é‚®ä»¶å¤´éƒ¨å’Œå‰10è¡Œ<br/>From: alice@sender.com<br/>To: bob@receiver.com<br/>Subject: æµ‹è¯•é‚®ä»¶<br/>...<br/>.
        
        Bob->>POP3: RETR 3
        POP3-->>Bob: +OK 1024å­—èŠ‚å†…å®¹<br/>From: alice@sender.com<br/>To: bob@receiver.com<br/>Subject: æµ‹è¯•é‚®ä»¶<br/><br/>è¿™æ˜¯é‚®ä»¶æ­£æ–‡<br/>.
        
        note over Bob: ğŸ“– ç”¨æˆ·é˜…è¯»é‚®ä»¶
        
        Bob->>POP3: DELE 3
        POP3-->>Bob: +OK é‚®ä»¶3å·²æ ‡è®°åˆ é™¤
        
        Bob->>POP3: QUIT
        POP3-->>Bob: +OK POP3æœåŠ¡å™¨é€€å‡º (1å°é‚®ä»¶å·²åˆ é™¤)
        note over Bob, POP3: ğŸ—‘ï¸ UPDATEçŠ¶æ€: æ‰§è¡Œåˆ é™¤æ“ä½œ
    end

    %% æµç¨‹å®Œæˆ
    note over Alice, Bob: âœ… é‚®ä»¶ä¼ è¾“å®Œæˆ
    note over Alice, Bob: æ•´ä¸ªæµç¨‹æ¶‰åŠçš„RFCæ ‡å‡†:<br/>RFC 5321 (SMTP), RFC 1939 (POP3)<br/>RFC 5322 (é‚®ä»¶æ ¼å¼), RFC 6409 (é‚®ä»¶æäº¤)
```

## åè®®çŠ¶æ€è½¬æ¢å›¾

```mermaid
stateDiagram-v2
    [*] --> SMTP_Connection: å®¢æˆ·ç«¯å‘èµ·è¿æ¥
    
    state "SMTPåè®®æµç¨‹" as SMTP_Flow {
        SMTP_Connection --> SMTP_Greeting: 220 æœåŠ¡å°±ç»ª
        SMTP_Greeting --> SMTP_EHLO: EHLOå‘½ä»¤
        SMTP_EHLO --> SMTP_Auth: AUTHè®¤è¯(å¯é€‰)
        SMTP_EHLO --> SMTP_Mail: è·³è¿‡è®¤è¯
        SMTP_Auth --> SMTP_Mail: 235 è®¤è¯æˆåŠŸ
        SMTP_Mail --> SMTP_Rcpt: MAIL FROM
        SMTP_Rcpt --> SMTP_Data: RCPT TO
        SMTP_Data --> SMTP_Content: DATAå‘½ä»¤
        SMTP_Content --> SMTP_Complete: é‚®ä»¶å†…å®¹ä¼ è¾“
        SMTP_Complete --> SMTP_Quit: 250 æ¥å—æˆåŠŸ
        SMTP_Quit --> [*]: QUIT
    }
    
    SMTP_Complete --> POP3_Storage: é‚®ä»¶å­˜å‚¨
    
    state "POP3åè®®æµç¨‹" as POP3_Flow {
        [*] --> POP3_Connection: å®¢æˆ·ç«¯è¿æ¥
        POP3_Connection --> POP3_Auth: +OK æœåŠ¡å°±ç»ª
        
        state "AUTHORIZATIONçŠ¶æ€" as AUTH_STATE {
            POP3_Auth --> POP3_User: USERå‘½ä»¤
            POP3_User --> POP3_Pass: PASSå‘½ä»¤
            POP3_Pass --> POP3_Ready: +OK è®¤è¯æˆåŠŸ
        }
        
        state "TRANSACTIONçŠ¶æ€" as TRANS_STATE {
            POP3_Ready --> POP3_Stat: STATå‘½ä»¤
            POP3_Ready --> POP3_List: LISTå‘½ä»¤
            POP3_Ready --> POP3_Retr: RETRå‘½ä»¤
            POP3_Ready --> POP3_Dele: DELEå‘½ä»¤
            POP3_Ready --> POP3_Uidl: UIDLå‘½ä»¤
            POP3_Ready --> POP3_Top: TOPå‘½ä»¤
            POP3_Stat --> POP3_Ready
            POP3_List --> POP3_Ready
            POP3_Retr --> POP3_Ready
            POP3_Dele --> POP3_Ready
            POP3_Uidl --> POP3_Ready
            POP3_Top --> POP3_Ready
        }
        
        state "UPDATEçŠ¶æ€" as UPDATE_STATE {
            POP3_Ready --> POP3_Quit: QUITå‘½ä»¤
            POP3_Quit --> POP3_Update: æ‰§è¡Œåˆ é™¤æ“ä½œ
            POP3_Update --> [*]: è¿æ¥å…³é—­
        }
    }
    
    POP3_Storage --> POP3_Connection: ç”¨æˆ·æ£€ç´¢é‚®ä»¶
```

## é”™è¯¯å¤„ç†æµç¨‹å›¾

```mermaid
flowchart TD
    A[SMTP/POP3å‘½ä»¤] --> B{å‘½ä»¤æ ¼å¼æ£€æŸ¥}
    B -->|æ ¼å¼é”™è¯¯| C[5xx/ERR è¯­æ³•é”™è¯¯]
    B -->|æ ¼å¼æ­£ç¡®| D{æƒé™æ£€æŸ¥}
    D -->|æƒé™ä¸è¶³| E[5xx/ERR æƒé™æ‹’ç»]
    D -->|æƒé™è¶³å¤Ÿ| F{èµ„æºæ£€æŸ¥}
    F -->|èµ„æºä¸è¶³| G{é”™è¯¯ç±»å‹}
    G -->|ä¸´æ—¶é”™è¯¯| H[4xx ä¸´æ—¶å¤±è´¥]
    G -->|æ°¸ä¹…é”™è¯¯| I[5xx æ°¸ä¹…å¤±è´¥]
    F -->|èµ„æºå……è¶³| J[æ‰§è¡Œå‘½ä»¤]
    J --> K{æ‰§è¡Œç»“æœ}
    K -->|æˆåŠŸ| L[2xx/+OK æˆåŠŸå“åº”]
    K -->|å¤±è´¥| M[4xx/5xx/-ERR å¤±è´¥å“åº”]
    
    style C fill:#ffcccc
    style E fill:#ffcccc
    style H fill:#ffffcc
    style I fill:#ffcccc
    style L fill:#ccffcc
    style M fill:#ffcccc
```

## å®‰å…¨æœºåˆ¶å¯¹æ¯”å›¾

```mermaid
mindmap
  root((é‚®ä»¶åè®®å®‰å…¨))
    SMTPå®‰å…¨
      ä¼ è¾“åŠ å¯†
        STARTTLSå‡çº§
        ç›´æ¥TLSè¿æ¥
      è®¤è¯æœºåˆ¶
        PLAINè®¤è¯
        LOGINè®¤è¯
        CRAM-MD5æ‘˜è¦
        OAUTH2ä»¤ç‰Œ
      æ‰©å±•å®‰å…¨
        SPFå‘é€æ–¹ç­–ç•¥
        DKIMæ•°å­—ç­¾å
        DMARCåŸŸåè®¤è¯
    POP3å®‰å…¨
      ä¼ è¾“åŠ å¯†
        SSL/TLSè¿æ¥
        STLSå‡çº§(å°‘è§)
      è®¤è¯æœºåˆ¶
        USER/PASSæ˜æ–‡
        APOPæ‘˜è¦è®¤è¯
      è¿æ¥å®‰å…¨
        ä¼šè¯è¶…æ—¶
        è¿æ¥æ•°é™åˆ¶
        IPè®¿é—®æ§åˆ¶
```

## å›¾è¡¨è½¬æ¢è¯´æ˜

### è½¬æ¢ä¸ºé«˜åˆ†è¾¨ç‡å›¾åƒçš„æ–¹æ³•

1. **ä½¿ç”¨Mermaid CLIå·¥å…·**
```bash
# å®‰è£…Mermaid CLI
npm install -g @mermaid-js/mermaid-cli

# è½¬æ¢ä¸ºPNG (é€‚åˆA0å°ºå¯¸: 4768x6741åƒç´ ï¼Œ300DPI)
mmdc -i é‚®ä»¶åè®®äº¤äº’æµç¨‹å›¾.md -o email_protocol_flow.png -w 4768 -h 6741 -s 3

# è½¬æ¢ä¸ºSVG (çŸ¢é‡æ ¼å¼ï¼Œæ— é™ç¼©æ”¾)
mmdc -i é‚®ä»¶åè®®äº¤äº’æµç¨‹å›¾.md -o email_protocol_flow.svg

# è½¬æ¢ä¸ºPDF
mmdc -i é‚®ä»¶åè®®äº¤äº’æµç¨‹å›¾.md -o email_protocol_flow.pdf
```

2. **ä½¿ç”¨åœ¨çº¿å·¥å…·**
- Mermaid Live Editor (https://mermaid.live/)
- æ”¯æŒç›´æ¥å¯¼å‡ºSVG/PNGæ ¼å¼
- å¯è°ƒæ•´è¾“å‡ºåˆ†è¾¨ç‡å’Œå°ºå¯¸

3. **å­¦æœ¯æµ·æŠ¥åˆ¶ä½œå»ºè®®**
- **å°ºå¯¸**: A0 (841Ã—1189mm)
- **åˆ†è¾¨ç‡**: 300 DPI
- **é¢œè‰²æ¨¡å¼**: RGBï¼ˆå±å¹•æ˜¾ç¤ºï¼‰æˆ– CMYKï¼ˆå°åˆ·ï¼‰
- **å­—ä½“å¤§å°**: æ ‡é¢˜â‰¥72ptï¼Œæ­£æ–‡â‰¥24pt
- **ç•™ç™½**: è¾¹è·è‡³å°‘25mm

### å›¾è¡¨è‡ªå®šä¹‰é…ç½®

```javascript
// Mermaidé…ç½®ç”¨äºA0æµ·æŠ¥ä¼˜åŒ–
{
  "theme": "default",
  "themeVariables": {
    "primaryColor": "#ffffff",
    "primaryTextColor": "#000000",
    "primaryBorderColor": "#000000",
    "lineColor": "#000000",
    "fontFamily": "Arial, sans-serif",
    "fontSize": "16px"
  },
  "sequence": {
    "diagramMarginX": 50,
    "diagramMarginY": 50,
    "actorMargin": 80,
    "width": 200,
    "height": 60,
    "boxMargin": 20,
    "boxTextMargin": 10,
    "noteMargin": 20,
    "messageMargin": 50
  }
}
```

### é¢œè‰²è¯´æ˜

- ğŸ”´ **çº¢è‰²åŒºåŸŸ**: SMTPé‚®ä»¶æäº¤é˜¶æ®µ
- ğŸŸ¢ **ç»¿è‰²åŒºåŸŸ**: SMTPæœåŠ¡å™¨é—´ä¼ è¾“
- ğŸ”µ **è“è‰²åŒºåŸŸ**: POP3é‚®ä»¶æ£€ç´¢é˜¶æ®µ
- ğŸ”’ **å®‰å…¨æ ‡è¯†**: TLS/SSLåŠ å¯†è¿æ¥
- ğŸ“§ğŸ“ğŸ“– **å›¾æ ‡**: ä¸åŒé˜¶æ®µçš„åŠŸèƒ½æ ‡è¯† 